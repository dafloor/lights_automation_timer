blueprint:
  name: Bewegingsgestuurd Licht met Expliciete Timer (Dag/Nacht)
  description: >
    Schakelt een licht/scene in bij beweging en start/herstart een opgegeven timer.
    Schakelt het licht uit wanneer die timer afloopt.
    Gebruikt verschillende acties voor dag en nacht.
    Vereist een vooraf aangemaakte timer-helper.
  domain: automation
  input:
    motion_sensor:
      name: Bewegingssensor
      description: De binary_sensor die beweging detecteert.
      selector:
        entity:
          domain: binary_sensor
          device_class: motion
    light_target:
      name: Licht entiteit
      description: De primaire lamp die geschakeld moet worden (wordt gebruikt voor de 'uit' actie).
      selector:
        entity:
          domain: light
    timer_entity:
      name: Timer Helper
      description: >
        De timer.* helper entiteit die gebruikt wordt. Maak deze vooraf aan via
        Instellingen -> Apparaten & Services -> Helpers.
      selector:
        entity:
          domain: timer
    turn_on_action_day:
      name: Actie bij inschakelen (Dag)
      description: >
        Actie die uitgevoerd moet worden bij beweging overdag
        (bv. activeer scene.overloop_helder). Scenes bevatten meestal de juiste lamp(en).
        Voorbeeld: gebruik 'scene.turn_on' met een specifieke dag-scene.
      selector:
        action: {}
      default: []
    turn_on_action_night:
      name: Actie bij inschakelen (Nacht)
      description: >
        Actie die uitgevoerd moet worden bij beweging 's nachts
        (bv. activeer scene.overloop_nachtlampje). Scenes bevatten meestal de juiste lamp(en).
        Voorbeeld: gebruik 'scene.turn_on' met een specifieke nacht-scene.
      selector:
        action: {}
      default: []
    time_start_day:
      name: Starttijd Dag Helper
      description: >
        De input_datetime helper die het begin van de 'dag'-periode aangeeft.
        Voeg een standaardwaarde toe als dat handig is.
      selector:
        entity:
          domain: input_datetime
    time_start_night:
      name: Starttijd Nacht Helper
      description: >
        De input_datetime helper die het begin van de 'nacht'-periode aangeeft (einde dag-periode).
      selector:
        entity:
          domain: input_datetime
    timer_duration:
      name: Timer Duur
      description: >
        De duur voor de timer. Accepteert waarden in "HH:MM:SS" formaat
        of seconden als tekst (bijv. "300" voor 300 seconden).
      selector:
        text: {}
      default: "00:05:00"

# Modus: Queued voorkomt problemen als triggers snel achter elkaar komen,
# maar bootst niet exact de 'restart' van je originele 'aan' na als acties lang duren.
# 'single' zou de 'uit' actie kunnen missen als er net beweging is.
# 'restart' zou de 'uit' actie annuleren als er net beweging is.
# 'queued' is vaak een veilige keuze voor dit soort gecombineerde triggers.
mode: queued
max_exceeded: warning

trigger:
  # Trigger 1: Beweging gedetecteerd
  - platform: state
    entity_id: !input motion_sensor
    to: "on"
    id: motion_detected # ID om trigger te herkennen in acties

  # Trigger 2: Timer is afgelopen
  - platform: event
    event_type: timer.finished
    event_data:
      entity_id: !input timer_entity
    id: timer_finished # ID om trigger te herkennen in acties

condition: [] # Geen globale condities

action:
  - choose:
      # --- Acties voor Trigger 1: Beweging gedetecteerd ---
      - conditions:
          - condition: trigger
            id: motion_detected
        sequence:
          # Stap 1.1: Bepaal dag/nacht en voer de 'aan' actie uit
          # We voeren de actie altijd uit bij beweging; de scene/actie zelf
          # moet idealiter zorgen dat er niets geks gebeurt als het licht al aan is.
          - choose:
              - conditions:
                  # Conditie voor 'Dag'
                  - condition: time
                    after: !input time_start_day
                    before: !input time_start_night
                sequence: !input turn_on_action_day
              # Standaard actie ('Nacht')
                default: !input turn_on_action_night

          # Stap 1.2: Start (of herstart) de timer
          # timer.start herstart de timer automatisch als deze al liep.
          - service: timer.start
            target:
              entity_id: !input timer_entity
            data:
              duration: !input timer_duration

      # --- Acties voor Trigger 2: Timer is afgelopen ---
      - conditions:
          - condition: trigger
            id: timer_finished
        sequence:
          # Stap 2.1: Schakel het licht uit
          - service: light.turn_off
            target:
              # Gebruik de specifieke licht entiteit die is opgegeven
              entity_id: !input light_target

