blueprint:
  name: Bewegingsgestuurd Licht met Expliciete Timer (Dag/Nacht) v2
  description: >
    IMPROVED VERSION: Schakelt licht(en)/scene(s) in bij beweging en start/herstart een timer.
    Schakelt het doelwit uit wanneer de timer afloopt.
    Opties voor dag/nacht, alleen aanzetten als uit, en alleen uitzetten als aan.
    Vereist een vooraf aangemaakte timer-helper.
  domain: automation
  # Verbetering #6: Voeg hier een URL toe naar je Gist, repository of forum post
  source_url: https://github.com/UW_GEBRUIKERSNAAM/UW_REPO/blob/main/blueprints/motion_light_timer_explicit.yaml # VERVANG DIT!

  input:
    motion_sensor:
      name: Bewegingssensor
      description: De binary_sensor die beweging detecteert.
      selector:
        entity:
          domain: binary_sensor
          device_class: motion

    # Verbetering #1: Flexibeler doelwit
    light_target:
      name: Uit te schakelen doelwit(ten)
      description: >
        De lamp(en), groep(en) of gebied(en) die uitgeschakeld moeten worden na de timer.
        BELANGRIJK: Als je de opties 'Alleen aanzetten indien uitgeschakeld?' of
        'Alleen uitschakelen indien ingeschakeld?' gebruikt, werken deze het
        meest betrouwbaar als dit een *enkele* entiteit is waarvan de status ('on'/'off')
        de algehele status goed weergeeft.
      selector:
        target: # Gebruikt nu target selector
          entity:
            domain: light

    timer_entity:
      name: Timer Helper
      description: >
        De timer.* helper entiteit die gebruikt wordt. Maak deze vooraf aan via
        Instellingen -> Apparaten & Services -> Helpers.
      selector:
        entity:
          domain: timer

    turn_on_action_day:
      name: Actie bij inschakelen (Dag)
      description: >
        Actie die uitgevoerd moet worden bij beweging overdag (bv. activeer scene.overloop_helder).
        Voorbeeld: gebruik 'scene.turn_on' met een specifieke dag-scene.
      selector:
        action: {}
      default: []

    turn_on_action_night:
      name: Actie bij inschakelen (Nacht)
      description: >
        Actie die uitgevoerd moet worden bij beweging 's nachts (bv. activeer scene.overloop_nachtlampje).
        Voorbeeld: gebruik 'scene.turn_on' met een specifieke nacht-scene.
      selector:
        action: {}
      default: []

    time_start_day:
      name: Starttijd Dag Helper
      description: De input_datetime helper die het begin van de 'dag'-periode aangeeft.
      selector:
        entity:
          domain: input_datetime

    time_start_night:
      name: Starttijd Nacht Helper
      description: De input_datetime helper die het begin van de 'nacht'-periode aangeeft (einde dag-periode).
      selector:
        entity:
          domain: input_datetime

    timer_duration:
      name: Timer Duur
      description: >
        De duur voor de timer. Accepteert waarden in "HH:MM:SS" formaat
        of seconden als tekst (bijv. "300" voor 300 seconden).
      selector:
        text: {}
      default: "00:05:00"

mode: queued
max_exceeded: warning

trigger:
  - platform: state
    entity_id: !input motion_sensor
    to: "on"
    id: motion_detected

  - platform: event
    event_type: timer.finished
    event_data:
      entity_id: !input timer_entity
    id: timer_finished

condition: []

action:
  - choose:
      # --- Acties voor Trigger 1: Beweging gedetecteerd ---
      - conditions:
          - condition: trigger
            id: motion_detected
        sequence:
          # Stap 1.0: Verbetering #3 - Optionele check of licht al aan is
          # Ga alleen verder als de optie UIT staat, OF als de optie AAN staat EN het doelwit uit is.
          - condition: template
            value_template: "{{ not states(turn_on_only_if_off)|bool(false) or is_state(light_target.entity_id, 'off') }}"
            # Let op: Dit 'is_state' werkt alleen goed als light_target een enkele entity is.
            # Als het een groep/area is, moet de logica complexer zijn of de check weggelaten worden.
            # We gebruiken hier 'light_target.entity_id' als een aanname dat de selector een entity ID teruggeeft
            # voor deze check, ook al is het een target selector. Test dit goed!
            # Alternatief: Verwijder deze condition als je 'target' gebruikt voor groepen/areas.

          # Stap 1.1: Bepaal dag/nacht en voer de 'aan' actie uit
          - choose:
              - conditions:
                  - condition: time
                    after: !input time_start_day
                    before: !input time_start_night
                sequence: !input turn_on_action_day
                  - condition: time
                    after: !input time_start_night
                    before: !input time_start_day
                sequence: !input turn_on_action_night

          # Stap 1.2: Start (of herstart) de timer
          - service: timer.start
            target:
              entity_id: !input timer_entity
            data:
              duration: !input timer_duration

      # --- Acties voor Trigger 2: Timer is afgelopen ---
      - conditions:
          - condition: trigger
            id: timer_finished
        sequence:
          # Stap 2.2: Schakel het doelwit uit
          - service: light.turn_off
            target: !input light_target # Werkt correct met enkele entity, groep of area

